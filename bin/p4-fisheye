#! /usr/bin/zsh -feu

CRUCIBLE=crucible.py

usage()
{
    cat <<EOF
usage: ${0##*/} [+-h] [--] CL

Given the "pending perforce changelist" number, create a
Crucible/Fisheye review.

reviewers, moderator, repository  .... are hard-wired
title .. is the message of the CL.

the precommit patch is generated by p4-diff-list(1).

See "$CRUCIBLE --help" for possible tuning.

EOF
}

MYNAME=maruska
DEPOT=CR-DEPOT-LINUX

while getopts :h OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit 0
	    ;;
	*)
	    usage >&2
	    exit 2
    esac
done
shift OPTIND-1
OPTIND=1

if [ $# -lt 1 ]; then
    usage >&2; exit 1;
fi
# args
CL=$1

# could expand an array to @A1 @A2 ...
REVIEWER=@java

# precalculate
patchfile=$1.diff
RW_NAME="$(p4-message $CL)"


p4-diff-list $CL > $patchfile

$CRUCIBLE -u $MYNAME -m $RW_NAME -M $MYNAME  -f $patchfile $DEPOT $REVIEWER
