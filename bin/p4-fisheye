#! /usr/bin/zsh -feu

CRUCIBLE=crucible.py

usage()
{
    cat <<EOF
usage: ${0##*/} [+-h] [-r REVIEW-ID ] [-dv] [-e] [--] CL

-e   ... empty, no reviewer
-v -d ... verbose/debug


Given the "pending perforce changelist" number, create a
Crucible/Fisheye review.

reviewers, moderator, repository  .... are hard-wired
title .. is the message of the CL.

the precommit patch is generated by p4-diff-list(1).

See "$CRUCIBLE --help" for possible tuning.

REVIEW-ID is the whole, eg. CR-DEPOT-LINUX-1573
EOF
}

MYNAME=maruska
DEPOT=CR-DEPOT-LINUX
create_new_review=y
VERBOSE=n
# could expand an array to @A1 @A2 ...
REVIEWER=@java

while getopts :hr:dve OPT; do
    case $OPT in
	h|+h)
	    usage
	    exit 0
	    ;;
	e)
	    # empty
	    REVIEWER=@maruska
	    ;;
	d|v)
	    VERBOSE=y
	    ;;
	r)
	    create_new_review=n
	    review_nr="$OPTARG"
	    ;;
	*)
	    usage >&2
	    exit 2
    esac
done
shift OPTIND-1
OPTIND=1

if [ $# -lt 1 ]; then
    usage >&2; exit 1;
fi
# args
CL=$1


# precalculate
patchfile=$1.diff
RW_NAME="$(p4-message $CL)"

if [ $VERBOSE = y ]; then set -x;fi
p4-diff-list $CL > $patchfile

if [ $VERBOSE = y ]; then set -x;fi

if [ $create_new_review = y ]; then
    $CRUCIBLE --user $MYNAME --moderator $MYNAME \
	--title $RW_NAME  --file $patchfile --noanchor \
	$DEPOT $REVIEWER
else
    $CRUCIBLE  --newpatch --file $patchfile --noanchor $review_nr
fi
