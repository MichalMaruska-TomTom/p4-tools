#!/bin/bash -eu

# Produce a PATCH given by the pending changelist.
# todo:  exit if the CL is wrong.

function die(){
    echo $1
    exit -1
}

usage() {
cat <<EOF
usage: `basename $0` [+-c] [-d] [--] ARGS...
-c  colordiff
-d  plain diff, no doctoring
EOF
}

plain_diff=0
while getopts :cdh OPT; do
    case $OPT in
	c|+c)
	    P4DIFF=colordiff
	    ;;
	d|+d)
	    plain_diff=1
	    ;;
	h)
	    usage
	    exit 0
	    ;;
	*)
	    usage >&2
	    exit 2
    esac
done

shift `expr $OPTIND - 1`
OPTIND=1

if [ $# -lt 1 ]
then
    die "usage: $0 CL-number"
fi


SKIP_HEADER_AWK=${P4SHARE:-~/repo/p4-tools/share/}/skip-header.awk
SKIP_MIDDLE_FILE=${P4SHARE:-~/repo/p4-tools/share/}/skip-header2.awk
# echo $SKIP_HEADER_AWK >&2

# The produced patch contains a comment with the CL description.
echo "# $1"
p4-message $1| sed -e 's/^/#/'

# export sane default. Note that the (_short_) options are for
# diff(1) compatible!
P4DIFF=${P4DIFF:-diff}  \
    p4 opened -c $1 | sed -e 's/#.*$//' |\
    p4 -x - diff -d${P4DIFFOPTIONS:-bBNup} |\
    if [ $plain_diff = 0 ]; then
       awk -f $SKIP_HEADER_AWK |\
       awk -f $SKIP_MIDDLE_FILE
    else
       cat
    fi

# strip the +++ --- lines after ===

# -d-unified
# -b -B -N --show-c-function


# p4 depot ... root
#

# added files: diff with  /dev/null
p4 opened -c $1  | \
    grep  -F  -e '- add' |  sed -e 's/#.*$//'  |\
while read file;
do
    depotfile=$(p4 where $file| cut -f 1 -d ' ')
    info=$(p4 where $file| cut -f 3 -d ' ')
    (echo "==== ${depotfile}#0 - $info ===="; diff -${P4DIFFOPTIONS:-bBNup} /dev/null $info ) | awk -f $SKIP_HEADER_AWK
    #xargs --replace={} --max-lines 1 diff {} /dev/null
done





